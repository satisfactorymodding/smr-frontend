{"version":3,"file":"4.BUmMEdn4.js","sources":["../../../../../../src/routes/admin/announcements/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { getContextClient, queryStore } from '@urql/svelte';\n  import {\n    GetAnnouncementsDocument,\n    CreateAnnouncementDocument,\n    type Announcement,\n    AnnouncementImportance,\n    UpdateAnnouncementDocument,\n    DeleteAnnouncementDocument\n  } from '$lib/generated';\n  import { Accordion, AccordionItem, getToastStore } from '@skeletonlabs/skeleton';\n  const client = getContextClient();\n\n  let announcements: Announcement[] = [];\n  const nameFields = {};\n  let announcementNegativeID = -1;\n  const defaultNewAnnouncementMessage = 'New Announcement';\n\n  const annQuery = queryStore({\n    query: GetAnnouncementsDocument,\n    client\n  });\n\n  $: announcements = $annQuery.data?.getAnnouncements || [];\n\n  const toastStore = getToastStore();\n\n  function newAnnouncement() {\n    if (!announcements.find((announcement) => announcement.message == defaultNewAnnouncementMessage)) {\n      const announcement = {\n        id: announcementNegativeID--,\n        message: defaultNewAnnouncementMessage,\n        importance: AnnouncementImportance.Info\n      } as Announcement;\n      announcements.push(announcement);\n      announcements = announcements;\n      setTimeout(() => {\n        const field = nameFields[announcement.id];\n        field.focus();\n        const input = field.getElement().querySelectorAll('input')[0] as HTMLInputElement;\n        input.select();\n      }, 0);\n    } else {\n      nameFields[announcements[announcements.length - 1].id].focus();\n    }\n  }\n\n  async function announcementChange(announcement: Announcement) {\n    if (announcement.message == defaultNewAnnouncementMessage) {\n      return;\n    }\n\n    let success = false;\n    if (announcement.id < 0) {\n      // Create new tag & update tag.id with new DB id or re-fetch all tags\n      try {\n        const result = await client\n          .mutation(CreateAnnouncementDocument, {\n            announcement: { importance: announcement.importance, message: announcement.message }\n          })\n          .toPromise();\n        if (result.data) {\n          announcement.id = result.data.createAnnouncement.id;\n          success = true;\n        }\n      } catch (err) {\n        console.log(err);\n      }\n      if (!success) {\n        toastStore.trigger({\n          message: `Failed to create Announcement '${announcement.message}'!`,\n          background: 'variant-filled-error',\n          timeout: 2000\n        });\n        return;\n      }\n    } else {\n      // Update existing tag\n      try {\n        if (announcement.message.length > 0) {\n          success =\n            (\n              await client\n                .mutation(UpdateAnnouncementDocument, {\n                  id: announcement.id,\n                  announcement: { importance: announcement.importance, message: announcement.message }\n                })\n                .toPromise()\n            ).data.updateAnnouncement != null;\n        }\n      } catch {\n        // nothing\n      }\n      if (!success) {\n        toastStore.trigger({\n          message: `Failed to update Announcement '${announcement.message}'!`,\n          background: 'variant-filled-error',\n          timeout: 2000\n        });\n        return;\n      }\n    }\n\n    toastStore.trigger({\n      message: `Announcement '${announcement.message}' saved!`,\n      background: 'variant-filled-success',\n      timeout: 2000\n    });\n  }\n\n  async function deleteAnnouncement(announcement: Announcement) {\n    if (announcement.message != defaultNewAnnouncementMessage) {\n      let success = false;\n      try {\n        const result = await client.mutation(DeleteAnnouncementDocument, { id: announcement.id }).toPromise();\n        success = result.data.deleteAnnouncement;\n      } catch {\n        success = false;\n      }\n      if (!success) {\n        toastStore.trigger({\n          message: `Failed to remove Announcement '${announcement.message}'!`,\n          background: 'variant-filled-error',\n          timeout: 2000\n        });\n        return;\n      }\n    } else {\n      announcements.splice(announcements.indexOf(announcement), 1);\n    }\n\n    toastStore.trigger({\n      message: `Tag '${announcement.message}' removed!`,\n      background: 'variant-filled-success',\n      timeout: 2000\n    });\n  }\n\n  function onDeleteClick(e: Event, announcement: Announcement) {\n    e.stopPropagation();\n    deleteAnnouncement(announcement);\n  }\n</script>\n\n<h1>Announcements</h1>\n\n<div class=\"card\">\n  {#if $annQuery.fetching}\n    <h1>Loading announcements...</h1>\n  {:else if $annQuery.error}\n    <h1>Failed to load announcements: {$annQuery.error.message}</h1>\n  {:else}\n    <Accordion>\n      {#each announcements as announcement}\n        <AccordionItem>\n          <svelte:fragment slot=\"summary\"\n            >({announcement.importance}) {(() => {\n              const trimTo = 144;\n              const trimmed = announcement.message.substring(0, trimTo);\n              return announcement.message.length > trimTo ? trimmed + '...' : trimmed;\n            })()}</svelte:fragment>\n          <svelte:fragment slot=\"content\">\n            <div>\n              <div>Message</div>\n              <input\n                type=\"text\"\n                class=\"input p-2\"\n                bind:value={announcement.message}\n                placeholder=\"This is the text of the announcement\"\n                bind:this={nameFields[announcement.id]}\n                on:change={() => announcementChange(announcement)} />\n              <div>Importance (Fix, Info, Warning, Alert)</div>\n              <input\n                type=\"text\"\n                class=\"input p-2\"\n                bind:value={announcement.importance}\n                placeholder=\"Importance level\"\n                on:change={() => announcementChange(announcement)} />\n            </div>\n\n            <button class=\"variant-ghost-error btn\" on:click={(e) => onDeleteClick(e, announcement)}>\n              <span>Delete</span>\n            </button>\n          </svelte:fragment>\n        </AccordionItem>\n      {/each}\n    </Accordion>\n\n    <section class=\"p-4\">\n      <button class=\"variant-ghost-primary btn\" on:click={newAnnouncement}>\n        <span>Add new announcement</span>\n        <span class=\"material-icons\">add</span>\n      </button>\n    </section>\n  {/if}\n</div>\n\n<style lang=\"postcss\">\n  h1 {\n    @apply my-4 text-4xl font-bold;\n  }\n</style>\n"],"names":["insert_hydration_dev","target","section","anchor","append_hydration_dev","button","span0","span1","ctx","error","message","h1","set_data_dev","t1","t1_value","importance","dirty","div2","div0","input0","set_input_value","div1","input1","span","value","length","i","each_blocks","fetching","div","defaultNewAnnouncementMessage","client","getContextClient","announcements","nameFields","announcementNegativeID","annQuery","queryStore","query","GetAnnouncementsDocument","toastStore","getToastStore","newAnnouncement","find","announcement","id","focus","AnnouncementImportance","Info","push","setTimeout","field","getElement","querySelectorAll","input","select","async","announcementChange","success","result","mutation","CreateAnnouncementDocument","toPromise","data","createAnnouncement","err","console","log","trigger","background","timeout","UpdateAnnouncementDocument","updateAnnouncement","deleteAnnouncement","DeleteAnnouncementDocument","splice","indexOf","onDeleteClick","e","stopPropagation","this","$$value","change_handler","change_handler_1","click_handler","trimmed","substring","trimTo","$annQuery","getAnnouncements"],"mappings":"44CA4LIA,EAKSC,EAAAC,EAAAC,CAAAA,EAJPC,EAGQF,EAAAG,CAAAA,EAFND,EAAgCC,EAAAC,QAChCF,EAAAA,EAAsCC,EAAAE,0BAFYC,EAAe,CAAA,EAAA,GAAA,GAAA,GAAA,sVAvClCA,EAAS,CAACC,EAAAA,MAAMC,QAAO,yCAAtD,yGAAA,+IAAJV,CAAAA,EAA+DC,EAAAU,EAAAR,CAAAA,6CAA5BK,EAAS,CAACC,EAAAA,MAAMC,QAAO,KAAAE,EAAAC,EAAAC,CAAAA,maAF1Dd,EAAgCC,EAAAU,EAAAR,8KAQrBW,EAAAN,MAAaO,WAAU,6EAAzB,gBAA0B,IAAA,8BAA1B,GAAA,iBAA0B,IAAA,qFAAxBC,EAAA,GAAAF,KAAAA,EAAAN,MAAaO,WAAU,KAAAH,EAAAC,EAAAC,CAAAA,olDAM1Bd,EAgBKC,EAAAgB,EAAAd,CAAAA,EAfHC,EAAiBa,EAAAC,CAAAA,SACjBd,EAMsDa,EAAAE,CAHxCC,EAAAA,EAAAD,EAAAX,MAAaE,oBAI3BN,EAAgDa,EAAAI,QAChDjB,EAAAA,EAKsDa,EAAAK,CAFxCF,EAAAA,EAAAE,EAAAd,MAAaO,qBAK7Bf,EAEQC,EAAAI,EAAAF,CAAAA,EADNC,EAAkBC,EAAAkB,CAAAA,+JAdJP,EAAA,GAAAG,EAAAK,QAAAhB,MAAaE,SAAbU,EAAAD,EAAAX,MAAaE,sCAQbM,EAAA,GAAAM,EAAAE,QAAAhB,MAAaO,YAAbK,EAAAE,EAAAd,MAAaO,8uBAtB5BP,EAAa,CAAA,CAAA,uBAAlBiB,OAAIC,GAAA,gSAAClB,EAAa,sBAAlBiB,OAAIC,GAAA,EAAA,mHAAJD,OAAIC,EAAAC,EAAAF,OAAAC,GAAA,mDAAJD,OAAIC,GAAA,2TANL,OAAAlB,GAAUoB,EAAAA,SAAQ,EAEbpB,KAAUC,MAAK,0YAL3BT,EAAqBC,EAAAU,EAAAR,YAErBH,EAiDKC,EAAA4B,EAAA1B,CAAAA,0WAnLG,MAAA2B,EAAgC,uFALhC,MAAAC,EAASC,SAEXC,EAAa,SACXC,EAAU,CAAA,EACZ,IAAAC,EAAAA,GAGE,MAAAC,EAAWC,GAAU,CACzBC,MAAOC,GACPR,6CAKI,CAAA,EAAA,MAAAS,EAAaC,GAAAA,WAEVC,OACFT,EAAcU,KAAMC,GAAiBA,EAAalC,SAAWoB,GAehEI,EAAWD,EAAcA,EAAcR,OAAS,CAAA,EAAGoB,IAAIC,YAfsC,OACvFF,EAAY,CAChBC,GAAIV,IACJzB,QAASoB,EACTf,WAAYgC,GAAuBC,IAErCf,EAAAA,EAAcgB,KAAKL,iBAEnBM,gBACQ,MAAAC,EAAQjB,EAAWU,EAAaC,EAAAA,EACtCM,EAAML,QACQK,EAAMC,aAAaC,iBAAiB,OAAA,EAAS,CAC3DC,EAAMC,QAAM,EACX,CAAA,GAMQC,eAAAC,EAAmBb,MAC5BA,EAAalC,SAAWoB,SAIxB,IAAA4B,EAAU,MACVd,EAAaC,GAAK,EAAC,KAGb,MAAAc,EAAAA,MAAe5B,EAClB6B,SAASC,GAA0B,CAClCjB,aAAY,CAAI7B,WAAY6B,EAAa7B,WAAYL,QAASkC,EAAalC,WAE5EoD,UACC,EAAAH,EAAOI,OACTnB,EAAaC,GAAKc,EAAOI,KAAKC,mBAAmBnB,GACjDa,EAAU,UAELO,EAAAA,CACPC,QAAQC,IAAIF,OAETP,EAAO,CACVlB,EAAW4B,QAAO,CAChB1D,QAAO,kCAAoCkC,EAAalC,OACxD2D,KAAAA,WAAY,uBACZC,QAAS,uBAOP1B,EAAalC,QAAQe,OAAS,IAChCiC,GAAAA,MAEU3B,EACH6B,SAASW,GAA0B,CAClC1B,GAAID,EAAaC,GACjBD,aAAY,CAAI7B,WAAY6B,EAAa7B,WAAYL,QAASkC,EAAalC,OAAAA,CAAAA,CAAAA,EAE5EoD,UACHC,GAAAA,KAAKS,oBAAsB,gBAK9Bd,CAAAA,EAAO,CACVlB,EAAW4B,QAAO,CAChB1D,QAAO,kCAAoCkC,EAAalC,OAAAA,KACxD2D,WAAY,uBACZC,QAAS,cAMf9B,EAAW4B,QAAO,CAChB1D,QAAO,iBAAmBkC,EAAalC,OACvC2D,WAAAA,WAAY,yBACZC,QAAS,GAAA,CAAA,EAIEd,eAAAiB,EAAmB7B,MAC5BA,EAAalC,SAAWoB,EAA6B,CACnD,IAAA4B,EAAU,OAGZA,GADMC,MAAe5B,EAAO6B,SAASc,GAA8B,CAAA7B,GAAID,EAAaC,EAAAA,CAAAA,EAAMiB,aACzEC,KAAKU,wBAEtBf,CAAAA,EAAU,OAEPA,EAAO,CACVlB,EAAW4B,QAAO,CAChB1D,QAAO,kCAAoCkC,EAAalC,OAAAA,KACxD2D,WAAY,uBACZC,QAAS,mBAKbrC,EAAc0C,OAAO1C,EAAc2C,QAAQhC,CAAAA,EAAe,GAG5DJ,EAAW4B,QAAO,CAChB1D,QAAO,QAAUkC,EAAalC,oBAC9B2D,WAAY,yBACZC,QAAS,GAAA,CAAA,WAIJO,EAAcC,EAAUlC,EAAAA,CAC/BkC,EAAEC,gBACFN,EAAAA,EAAmB7B,wKA2BkBlC,QAAOsE,KAAAxD,+DAErBU,CAAAA,EAAWU,EAAaC,EAAEoC,EAAAA,WACpB,MAAAC,EAAAtC,GAAAa,EAAmBb,CAAAA,uBAKX7B,WAAUiE,KAAAxD,oBAElB,MAAA2D,EAAAvC,GAAAa,EAAmBb,CAAAA,EAGWwC,EAAA,CAAAxC,EAAAkC,IAAMD,EAAcC,EAAGlC,QAvBlE,OACAyC,EAAUzC,EAAalC,QAAQ4E,UAAU,EAAGC,GAC3C,EAAA,OAAA3C,EAAalC,QAAQe,OAAS8D,IAASF,EAAU,MAAQA,CAAO,gqBAxIhFpD,EAAgBuD,EAAUzB,MAAM0B,kBAAgB,CAAA,CAAA"}