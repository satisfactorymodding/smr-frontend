import{S as Re,i as Ue,d as R,Z as Ce,bf as me,s as De,a7 as A,a8 as O,a9 as H,u as C,t as T,ab as G,bg as pe,y as Be,ae as _e,g as z,f as j,e as S,af as D,b0 as Te,k as g,l as M,h as V,j as E,ag as B,ac as F,n as P,ad as b,p as I,r as $e,ai as Fe,v as je,am as K,an as Q,aH as W,aI as X,aG as Z,aE as ne,w as J,q as he,ah as L,x as q,m as re}from"../../../chunks/vendor-71586dff.js";import{p as ge}from"../../../chunks/routing-3e924f8c.js";import{T as ve}from"../../../chunks/Toast-a744ab82.js";import{g as ie}from"../../../chunks/navigation-fe373893.js";import{V as we}from"../../../chunks/VersionForm-d9241568.js";import{u as se,v as ae,w as ce,F as le,x as fe}from"../../../chunks/graphql-587ea9ba.js";import{b as ue}from"../../../chunks/paths-396f020f.js";import{M as xe}from"../../../chunks/MetaDescriptors-f6373408.js";import"../../../chunks/singletons-d1fb5791.js";import"../../../chunks/forms-a767280e.js";import"../../../chunks/jszip-581b0412.js";import"../../../chunks/extras-71f1917d.js";import"../../../chunks/uplugin-726ef6b7.js";import"../../../chunks/api-914d5f30.js";import"../../../chunks/user-aa766597.js";import"../../../chunks/forms-5941be64.js";import"../../../chunks/markdown-bc68363c.js";import"../../../chunks/formatting-a4ea5227.js";import"../../../chunks/stores-b24fbbcb.js";const de=async(i,e,o,r,n)=>{const s=Math.ceil(i.size/1e7),l=new Array(s).fill(0).map((m,f)=>f).reverse(),a=(m,f,y)=>n.uploadVersionPart({modId:e,versionId:y,part:f,file:m}),p=10;let u=0,$=0;const w=m=>{if(u>=p||!l.length)return;const f=l.pop(),y=f*1e7,k=i.slice(y,y+1e7);return u+=1,Promise.all([a(k,f+1,m).then(()=>(u-=1,r.set({total:s,uploaded:s-l.length-u}),w(m))).catch(x=>{if(console.error("Upload failed:",x),u-=1,l.push(f),$+=1,$<5)return w(m);throw new Error("Failed uploading after 5 attempts")}),w(m)])};return n.createVersion({modId:e}).then(async m=>(r.set({total:s,uploaded:0}),await w(m.data.createVersion),m.data.createVersion)).then(m=>(console.log("Finalizing",{versionID:m}),n.finalizeCreateVersion({modId:e,versionId:m,version:o}).then(()=>new Promise((f,y)=>{let k=0;const x=setInterval(()=>{if(k==60)return clearInterval(x),y(new Error("Timed out waiting for mod processing"));n.checkVersionUploadState.reexecute({requestPolicy:"network-only"}),k++},1e4);n.checkVersionUploadState.variables.versionId=m;const h=n.checkVersionUploadState.subscribe(c=>{if(!c.fetching){if(c.error){clearInterval(x),y(new Error(c.error.message)),setTimeout(h);return}!c.data||!c.data.checkVersionUploadState||!c.data.checkVersionUploadState.version||!c.data.checkVersionUploadState.version.id||(h(),clearInterval(x),f(c.data.checkVersionUploadState))}})})))).catch(m=>{throw console.error(m),m})},{console:be}=Ce,N="src/routes/mod/[modId]/new-version.svelte";function Y(i){let e,o;e=new xe({props:{description:"Creating a new version of mod "+i[1].data.mod.name,title:"New version of mod "+i[1].data.mod.name},$$inline:!0});const r={c:function(){A(e.$$.fragment)},l:function(t){O(e.$$.fragment,t)},m:function(t,s){H(e,t,s),o=!0},p:function(t,s){const l={};s&2&&(l.description="Creating a new version of mod "+t[1].data.mod.name),s&2&&(l.title="New version of mod "+t[1].data.mod.name),e.$set(l)},i:function(t){o||(C(e.$$.fragment,t),o=!0)},o:function(t){T(e.$$.fragment,t),o=!1},d:function(t){G(e,t)}};return R("SvelteRegisterBlock",{block:r,id:Y.name,type:"if",source:"(78:2) {#if !$mod.fetching && !$mod.error && $mod.data.mod}",ctx:i}),r}function ke(i){let e=i[1].data.mod.name+"",o;const r={c:function(){o=D(e)},l:function(t){o=B(t,e)},m:function(t,s){I(t,o,s)},p:function(t,s){s&2&&e!==(e=t[1].data.mod.name+"")&&L(o,e)},d:function(t){t&&g(o)}};return R("SvelteRegisterBlock",{block:r,id:ke.name,type:"if",source:"(89:24) ",ctx:i}),r}function ye(i){let e;const o={c:function(){e=D("...")},l:function(n){e=B(n,"...")},m:function(n,t){I(n,e,t)},p:q,d:function(n){n&&g(e)}};return R("SvelteRegisterBlock",{block:o,id:ye.name,type:"if",source:"(87:2) {#if $mod.fetching}",ctx:i}),o}function Ie(i){let e,o,r,n;e=new we({props:{onSubmit:i[8],modReference:i[1].data.mod.mod_reference},$$inline:!0});let t=i[3]&&ee(i);const s={c:function(){A(e.$$.fragment),o=j(),t&&t.c(),r=z()},l:function(a){O(e.$$.fragment,a),o=M(a),t&&t.l(a),r=z()},m:function(a,p){H(e,a,p),I(a,o,p),t&&t.m(a,p),I(a,r,p),n=!0},p:function(a,p){const u={};p&2&&(u.modReference=a[1].data.mod.mod_reference),e.$set(u),a[3]?t?t.p(a,p):(t=ee(a),t.c(),t.m(r.parentNode,r)):t&&(t.d(1),t=null)},i:function(a){n||(C(e.$$.fragment,a),n=!0)},o:function(a){T(e.$$.fragment,a),n=!1},d:function(a){G(e,a),a&&g(o),t&&t.d(a),a&&g(r)}};return R("SvelteRegisterBlock",{block:s,id:Ie.name,type:"else",source:"(100:4) {:else}",ctx:i}),s}function Se(i){let e,o,r=i[1].error.message+"",n;const t={c:function(){e=S("p"),o=D("Oh no... "),n=D(r),this.h()},l:function(l){e=V(l,"P",{});var a=E(e);o=B(a,"Oh no... "),n=B(a,r),a.forEach(g),this.h()},h:function(){P(e,N,98,6,3040)},m:function(l,a){I(l,e,a),b(e,o),b(e,n)},p:function(l,a){a&2&&r!==(r=l[1].error.message+"")&&L(n,r)},i:q,o:q,d:function(l){l&&g(e)}};return R("SvelteRegisterBlock",{block:t,id:Se.name,type:"if",source:"(98:25) ",ctx:i}),t}function Ve(i){let e,o;const r={c:function(){e=S("p"),o=D("Loading..."),this.h()},l:function(t){e=V(t,"P",{});var s=E(e);o=B(s,"Loading..."),s.forEach(g),this.h()},h:function(){P(e,N,96,6,2990)},m:function(t,s){I(t,e,s),b(e,o)},p:q,i:q,o:q,d:function(t){t&&g(e)}};return R("SvelteRegisterBlock",{block:r,id:Ve.name,type:"if",source:"(96:4) {#if $mod.fetching}",ctx:i}),r}function ee(i){let e,o,r,n,t,s,l,a,p=i[4].toFixed(0)+"",u,$,w,m,f;const y={c:function(){e=S("div"),o=S("div"),r=S("div"),n=S("span"),t=D(i[3]),s=j(),l=S("div"),a=S("span"),u=D(p),$=D("%"),w=j(),m=S("div"),f=S("div"),this.h()},l:function(x){e=V(x,"DIV",{class:!0});var h=E(e);o=V(h,"DIV",{class:!0});var c=E(o);r=V(c,"DIV",{});var v=E(r);n=V(v,"SPAN",{class:!0});var U=E(n);t=B(U,i[3]),U.forEach(g),v.forEach(g),s=M(c),l=V(c,"DIV",{class:!0});var d=E(l);a=V(d,"SPAN",{class:!0});var _=E(a);u=B(_,p),$=B(_,"%"),_.forEach(g),d.forEach(g),c.forEach(g),w=M(h),m=V(h,"DIV",{class:!0});var oe=E(m);f=V(oe,"DIV",{style:!0,class:!0}),E(f).forEach(g),oe.forEach(g),h.forEach(g),this.h()},h:function(){F(n,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),P(n,N,106,14,3323),P(r,N,105,12,3303),F(a,"class","text-xs font-semibold inline-block text-white"),P(a,N,112,14,3571),F(l,"class","text-right"),P(l,N,111,12,3532),F(o,"class","flex mb-2 items-center justify-between"),P(o,N,104,10,3238),re(f,"width",i[4].toFixed(0)+"%"),F(f,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),P(f,N,116,12,3797),F(m,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),P(m,N,115,10,3713),F(e,"class","relative pt-4"),P(e,N,103,8,3200)},m:function(x,h){I(x,e,h),b(e,o),b(o,r),b(r,n),b(n,t),b(o,s),b(o,l),b(l,a),b(a,u),b(a,$),b(e,w),b(e,m),b(m,f)},p:function(x,h){h&8&&L(t,x[3]),h&16&&p!==(p=x[4].toFixed(0)+"")&&L(u,p),h&16&&re(f,"width",x[4].toFixed(0)+"%")},d:function(x){x&&g(e)}};return R("SvelteRegisterBlock",{block:y,id:ee.name,type:"if",source:"(103:6) {#if $uploadStatus}",ctx:i}),y}function Ee(i){let e,o,r,n;const t=[Ve,Se,Ie],s=[];function l(p,u){return p[1].fetching?0:p[1].error?1:2}e=l(i),o=s[e]=t[e](i);const a={c:function(){o.c(),r=z()},l:function(u){o.l(u),r=z()},m:function(u,$){s[e].m(u,$),I(u,r,$),n=!0},p:function(u,$){let w=e;e=l(u),e===w?s[e].p(u,$):(he(),T(s[w],1,1,()=>{s[w]=null}),$e(),o=s[e],o?o.p(u,$):(o=s[e]=t[e](u),o.c()),C(o,1),o.m(r.parentNode,r))},i:function(u){n||(C(o),n=!0)},o:function(u){T(o),n=!1},d:function(u){s[e].d(u),u&&g(r)}};return R("SvelteRegisterBlock",{block:a,id:Ee.name,type:"slot",source:"(95:2) <Content>",ctx:i}),a}function Pe(i){let e,o;e=new pe({props:{$$slots:{default:[Ee]},$$scope:{ctx:i}},$$inline:!0});const r={c:function(){A(e.$$.fragment)},l:function(t){O(e.$$.fragment,t)},m:function(t,s){H(e,t,s),o=!0},p:function(t,s){const l={};s&65562&&(l.$$scope={dirty:s,ctx:t}),e.$set(l)},i:function(t){o||(C(e.$$.fragment,t),o=!0)},o:function(t){T(e.$$.fragment,t),o=!1},d:function(t){G(e,t)}};return R("SvelteRegisterBlock",{block:r,id:Pe.name,type:"slot",source:"(94:0) <Card>",ctx:i}),r}function Ne(i){let e,o;const r={c:function(){e=S("span"),o=D(i[2]),this.h()},l:function(t){e=V(t,"SPAN",{});var s=E(e);o=B(s,i[2]),s.forEach(g),this.h()},h:function(){P(e,N,127,2,4093)},m:function(t,s){I(t,e,s),b(e,o)},p:function(t,s){s&4&&L(o,t[2])},d:function(t){t&&g(e)}};return R("SvelteRegisterBlock",{block:r,id:Ne.name,type:"slot",source:"(127:0) <Toast bind:running={errorToast}>",ctx:i}),r}function te(i){let e,o,r,n,t,s,l,a,p,u,$=!i[1].fetching&&!i[1].error&&i[1].data.mod&&Y(i);function w(h,c){if(h[1].fetching)return ye;if(!h[1].error)return ke}let m=w(i),f=m&&m(i);s=new me({props:{$$slots:{default:[Pe]},$$scope:{ctx:i}},$$inline:!0});function y(h){i[10](h)}let k={$$slots:{default:[Ne]},$$scope:{ctx:i}};i[0]!==void 0&&(k.running=i[0]),a=new ve({props:k,$$inline:!0}),Be.push(()=>_e(a,"running",y));const x={c:function(){$&&$.c(),e=z(),o=j(),r=S("h1"),n=D(`New Version for
  `),f&&f.c(),t=j(),A(s.$$.fragment),l=j(),A(a.$$.fragment),this.h()},l:function(c){const v=Te('[data-svelte="svelte-nx2zao"]',document.head);$&&$.l(v),e=z(),v.forEach(g),o=M(c),r=V(c,"H1",{class:!0});var U=E(r);n=B(U,`New Version for
  `),f&&f.l(U),U.forEach(g),t=M(c),O(s.$$.fragment,c),l=M(c),O(a.$$.fragment,c),this.h()},h:function(){F(r,"class","text-4xl my-4 font-bold"),P(r,N,84,0,2791)},m:function(c,v){$&&$.m(document.head,null),b(document.head,e),I(c,o,v),I(c,r,v),b(r,n),f&&f.m(r,null),I(c,t,v),H(s,c,v),I(c,l,v),H(a,c,v),u=!0},p:function(c,[v]){!c[1].fetching&&!c[1].error&&c[1].data.mod?$?($.p(c,v),v&2&&C($,1)):($=Y(c),$.c(),C($,1),$.m(e.parentNode,e)):$&&(he(),T($,1,1,()=>{$=null}),$e()),m===(m=w(c))&&f?f.p(c,v):(f&&f.d(1),f=m&&m(c),f&&(f.c(),f.m(r,null)));const U={};v&65562&&(U.$$scope={dirty:v,ctx:c}),s.$set(U);const d={};v&65540&&(d.$$scope={dirty:v,ctx:c}),!p&&v&1&&(p=!0,d.running=c[0],Fe(()=>p=!1)),a.$set(d)},i:function(c){u||(C($),C(s.$$.fragment,c),C(a.$$.fragment,c),u=!0)},o:function(c){T($),T(s.$$.fragment,c),T(a.$$.fragment,c),u=!1},d:function(c){$&&$.d(c),g(e),c&&g(o),c&&g(r),f&&f.d(),c&&g(t),G(s,c),c&&g(l),G(a,c)}};return R("SvelteRegisterBlock",{block:x,id:te.name,type:"component",source:"",ctx:i}),x}const Me=ge();function qe(i,e,o){let r,n,t,{$$slots:s={},$$scope:l}=e;je("New_version",s,[]);let{modId:a}=e;const p=J("");K(p,"uploadStatus"),Q(i,p,d=>o(3,n=d));const u=J(0);K(u,"uploadPercent"),Q(i,u,d=>o(4,t=d));const $=J();$.subscribe(d=>{d&&(d.uploaded===d.total?(p.set("Processing..."),u.set(100)):(p.set(`Uploading: ${d.uploaded}/${d.total}`),u.set(d.uploaded/d.total*100)))});let w="",m=!1;const f=W(se,{mod:a});K(f,"mod"),Q(i,f,d=>o(1,r=d)),X(f);const y=Z({query:ce}),k=Z({query:fe}),x=Z({query:le}),h=W(ae,{versionId:void 0,modId:void 0},{pause:!0});X(h);const c=async d=>de(d.file,ne(f).data.mod.id,{changelog:d.changelog,stability:d.stability},$,{createVersion:y,uploadVersionPart:k,finalizeCreateVersion:x,checkVersionUploadState:h}).then(_=>{console.log({success:_}),ie(ue+"/mod/"+a+"/version/"+_.version.id)}).catch(_=>{console.error(_),o(2,w="Error creating version: "+_.message),o(0,m=!0),p.set("")}),v=["modId"];Object.keys(e).forEach(d=>{!~v.indexOf(d)&&d.slice(0,2)!=="$$"&&d!=="slot"&&be.warn(`<New_version> was created with unknown prop '${d}'`)});function U(d){m=d,o(0,m)}return i.$$set=d=>{"modId"in d&&o(9,a=d.modId)},i.$capture_state=()=>({paramsToProps:ge,load:Me,mutation:Z,operationStore:W,query:X,Toast:ve,goto:ie,VersionForm:we,CheckVersionUploadStateDocument:ae,CreateVersionDocument:ce,FinalizeCreateVersionDocument:le,GetModReferenceDocument:se,UploadVersionPartDocument:fe,get:ne,writable:J,chunkedUpload:de,base:ue,MetaDescriptors:xe,Card:me,Content:pe,modId:a,uploadStatus:p,uploadPercent:u,uploadState:$,errorMessage:w,errorToast:m,mod:f,createVersion:y,uploadVersionPart:k,finalizeCreateVersion:x,checkVersionUploadState:h,onSubmit:c,$mod:r,$uploadStatus:n,$uploadPercent:t}),i.$inject_state=d=>{"modId"in d&&o(9,a=d.modId),"errorMessage"in d&&o(2,w=d.errorMessage),"errorToast"in d&&o(0,m=d.errorToast)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty&2&&r.data&&(h.variables.modId=r.data.mod.id),i.$$.dirty&1&&(m||o(2,w=""))},[m,r,w,n,t,p,u,f,c,a,U]}class st extends Re{constructor(e){super(e),Ue(this,e,qe,te,De,{modId:9}),R("SvelteRegisterComponent",{component:this,tagName:"New_version",options:e,id:te.name});const{ctx:o}=this.$$,r=e.props||{};o[9]===void 0&&!("modId"in r)&&be.warn("<New_version> was created without expected prop 'modId'")}get modId(){throw new Error("<New_version>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set modId(e){throw new Error("<New_version>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{st as default,Me as load};
//# sourceMappingURL=new-version.svelte-984c6398.js.map
