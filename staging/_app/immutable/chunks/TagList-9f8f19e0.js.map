{"version":3,"file":"TagList-9f8f19e0.js","sources":["../../../../../../src/lib/components/utils/TagList.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { GetTagsDocument } from '$lib/generated/graphql';\n  import type { Tag } from '$lib/generated/graphql';\n  import Chip, { Set, Text } from '@smui/chips';\n  import MenuSurface from '@smui/menu-surface';\n  import { operationStore, query } from '@urql/svelte';\n  import type { MenuSurfaceComponentDev } from '@smui/menu-surface/src/MenuSurface.types';\n  import Textfield, { Input } from '@smui/textfield';\n  import FloatingLabel from '@smui/floating-label';\n  import LineRipple from '@smui/line-ripple';\n  import type { InputComponentDev } from '@smui/textfield';\n  import type { LineRippleComponentDev } from '@smui/line-ripple';\n\n  const getAllTags = operationStore(GetTagsDocument);\n\n  export let tags: Tag[] = [];\n  export let editable = false;\n\n  let inputA: InputComponentDev;\n  let lineRippleA: LineRippleComponentDev;\n\n  let shake = false;\n\n  let allTags: Tag[] = [];\n  let filteredTagsMatched: Tag[] = [];\n  let filteredTagsUnmatched: Tag[] = [];\n\n  let newTagText: string;\n\n  let newTag: HTMLInputElement;\n  let newTagContainer: HTMLElement = null;\n  let surface: MenuSurfaceComponentDev;\n\n  let focused = false;\n\n  $: newTag = inputA?.getElement();\n\n  function filterAvailableTags(tagList: Tag[], currentTags: Tag[], filterText: string): [Tag[], Tag[]] {\n    if (!tagList || !currentTags) {\n      return [tagList, tagList];\n    }\n    let unfiltered = tagList.filter((tag) => !currentTags.find((t) => t.id == tag.id));\n    const filtered = unfiltered.filter((tag) => !newTag || tag.name.startsWith(filterText));\n    unfiltered = unfiltered.filter((tag) => filtered.findIndex((t) => t.id === tag.id) === -1);\n    return [filtered, unfiltered];\n  }\n\n  function updateTags() {\n    tags = tags;\n    [filteredTagsMatched, filteredTagsUnmatched] = filterAvailableTags(allTags, tags, newTagText);\n  }\n\n  if (editable) {\n    query(getAllTags);\n    getAllTags.subscribe(() => {\n      if (!getAllTags.fetching && !getAllTags.error) {\n        allTags = getAllTags.data.getTags;\n        updateTags();\n      }\n    });\n  }\n\n  function setTagText(text: string) {\n    newTagText = text;\n    newTag.value = newTagText;\n  }\n\n  export function setTextRange(el: HTMLInputElement, start: number, end: number): void {\n    el.focus();\n    if (typeof window.getSelection != 'undefined' && typeof document.createRange != 'undefined') {\n      el.setSelectionRange(start, end);\n    }\n  }\n\n  export function placeCaretAtEnd(el: HTMLInputElement): void {\n    el.focus();\n    if (typeof window.getSelection != 'undefined' && typeof document.createRange != 'undefined') {\n      el.setSelectionRange(el.value.length, el.value.length);\n    }\n  }\n\n  function addTag(newTagObj: string | Tag) {\n    if (!allTags) {\n      return false;\n    }\n    const tagToAdd = allTags.find((tag) => {\n      if (typeof newTagObj == 'string') {\n        return newTagObj == tag.name || newTagObj == tag.id;\n      } else {\n        return newTagObj.id == tag.id;\n      }\n    }) as Tag;\n    if (tagToAdd && !tags.find((tag) => tag.id == tagToAdd.id)) {\n      tags.push(tagToAdd);\n      updateTags();\n      return true;\n    }\n    updateTags();\n    return false;\n  }\n\n  function deleteTag(tag: Tag) {\n    tags = tags.filter((v) => v != tag);\n    updateTags();\n  }\n\n  function newTagKeydown(e: Event) {\n    if (!(e instanceof KeyboardEvent)) {\n      return;\n    }\n    if (e.code == 'Backspace') {\n      if (newTag.value == '') {\n        setTagText(tags.pop().name);\n        placeCaretAtEnd(newTag);\n        tags = tags;\n        e.preventDefault();\n        updateTags();\n      }\n    } else if (e.code == 'Enter') {\n      e.preventDefault();\n      if (addTag(newTag.value)) {\n        setTagText('');\n        updateTags();\n      } else {\n        shake = true;\n        setTimeout(() => (shake = false), 500);\n      }\n    } else {\n      const newText = newTagText + e.key;\n      const [available] = filterAvailableTags(allTags, tags, newText);\n      if (available && available.length > 0) {\n        newTag.value = available[0].name;\n        setTextRange(newTag, newTagText.length + 1, newTag.value.length);\n        e.preventDefault();\n        newTagText = newText;\n        updateTags();\n      }\n    }\n  }\n\n  function onFocusLost() {\n    setTimeout(() => {\n      if (newTagContainer && !newTagContainer.contains(document.activeElement)) {\n        surface.setOpen(false);\n      }\n    }, 200);\n  }\n\n  function onInput(e: Event) {\n    newTagText = newTag.value;\n    updateTags();\n    e.preventDefault();\n  }\n</script>\n\n<div class=\"tags\" on:focusin={() => (focused = true)} on:focusout={() => (focused = false)}>\n  {#if !editable}\n    {#if tags.length > 0}\n      <div class=\"flex flex-row flex-wrap text-sm gap-1\">\n        {#each tags as tag}\n          <div class=\"text-neutral-300 lowercase\">\n            <span class=\"text-orange-500\">#</span>{tag.name}\n          </div>\n        {/each}\n      </div>\n    {/if}\n  {:else}\n    <Textfield class=\"tags overflow-visible\" bind:lineRipple={lineRippleA} bind:input={inputA} style=\"z-index: 9999\">\n      <FloatingLabel\n        class=\"pb-2\"\n        for=\"input-manual-a\"\n        slot=\"label\"\n        floatAbove={(newTag && newTag.value.length > 0) || focused || tags.length > 0}>Tags</FloatingLabel>\n      <div class=\"flex flex-row flex-wrap text-sm gap-1 mr-2\">\n        {#each tags as tag}\n          <div class=\"text-neutral-300 whitespace-nowrap flex removable-tag\">\n            <span class=\"hashtag text-orange-500\">#</span>\n            <span class=\"cancel\">\n              <i class=\"material-icons mdc-chip__icon mdc-chip__icon--trailing\" on:click={() => deleteTag(tag)}\n                >cancel</i>\n            </span>\n            <p>{tag.name}</p>\n          </div>\n        {/each}\n        <div\n          id=\"newTagContainer\"\n          class=\"text-neutral-300 whitespace-nowrap flex\"\n          bind:this={newTagContainer}\n          on:focusin={() => surface.setOpen(true)}\n          on:focusout={onFocusLost}>\n          <MenuSurface bind:this={surface} managed={true} anchorCorner=\"BOTTOM_LEFT\" anchorElement={newTag}>\n            <div style=\"margin: 1rem\">\n              <h1>Available Tags</h1>\n              <div class=\"flex flex-wrap m-1\">\n                <Set chips={filteredTagsMatched} let:chip key={(tag) => tag.name}>\n                  <Chip {chip} on:SMUIChip:interaction={() => addTag(chip.name)}>\n                    <Text>{chip.name}</Text>\n                  </Chip>\n                </Set>\n              </div>\n              <div class=\"flex flex-wrap m-1\">\n                <Set chips={filteredTagsUnmatched} let:chip key={(tag) => tag.name}>\n                  <Chip {chip} on:SMUIChip:interaction={() => addTag(chip.name)}>\n                    <Text>{chip.name}</Text>\n                  </Chip>\n                </Set>\n              </div>\n            </div>\n          </MenuSurface>\n          {#if focused}\n            <span class=\"text-orange-500\">#</span>\n          {/if}\n          <Input\n            id=\"input-manual-a\"\n            spellcheck=\"false\"\n            autocomplete=\"off\"\n            class=\"inline text-sm text-neutral-300 {shake ? 'shake' : ''}\"\n            style=\"height: initial\"\n            bind:this={inputA}\n            on:keydown={newTagKeydown}\n            on:input={onInput} />\n        </div>\n      </div>\n      <LineRipple bind:this={lineRippleA} slot=\"ripple\" />\n    </Textfield>\n  {/if}\n</div>\n\n<style lang=\"scss\">\n  .removable-tag {\n    .cancel {\n      display: none;\n      cursor: pointer;\n\n      i {\n        padding: 0;\n        margin: 0;\n      }\n    }\n\n    &:hover {\n      .hashtag {\n        display: none;\n      }\n\n      .cancel {\n        display: initial;\n      }\n    }\n  }\n</style>\n"],"names":["ctx","length","create_if_block_1","t4_value","name","insert_hydration","target","div","anchor","append_hydration","span0","span1","i","p","dirty","set_data","t4","t_value","t","div2","h1","div0","div1","span","create_if_block_2","floatAbove","value","floatinglabel_changes","t1_value","t1","el","start","end","focus","window","getSelection","document","createRange","setSelectionRange","tag","getAllTags","operationStore","GetTagsDocument","tags","$$props","editable","inputA","lineRippleA","shake","allTags","filteredTagsMatched","filteredTagsUnmatched","newTagText","newTag","newTagContainer","surface","focused","tagList","currentTags","filterText","unfiltered","filter","find","id","filtered","startsWith","findIndex","updateTags","filterAvailableTags","$$invalidate","query","subscribe","fetching","error","data","getTags","text","newTagObj","tagToAdd","push","v","e","KeyboardEvent","code","setTagText","pop","placeCaretAtEnd","preventDefault","addTag","setTimeout","newText","key","available","setTextRange","onFocusLost","contains","activeElement","setOpen","$$value","click_handler","deleteTag","chip","focusin_handler_1","focusout_handler","getElement"],"mappings":"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"}