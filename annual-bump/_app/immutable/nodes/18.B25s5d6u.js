import{as as me,I as Pe,a as Me,p as Ee,W as ze,X as Te,w as W,A as Ue,J as Be,f as Ie,g as B,K as qe,h as T,m as c,z as ce,k as _,_ as O,q as d,r as Ge,t as Ne,N as Oe,D as X,n as V,C as j,L as s,u as je,a0 as U,F,y as I,G as A,ae as de,af as le,ac as ue,R as n,ad as Ae,aH as Le}from"../chunks/C6V5fW-3.js";import{V as Qe}from"../chunks/CFOsge0N.js";import{y as De,F as Ke,z as Re,B as He,t as Je}from"../chunks/Bj1PSOzY.js";import{M as We}from"../chunks/B7wvMWpi.js";import{E as Xe}from"../chunks/sF2VbG2D.js";import{t as pe}from"../chunks/BLzR2Xnx.js";import{B as Ye}from"../chunks/DirYF3zW.js";const Ze=async({params:w})=>({...w}),mt=Object.freeze(Object.defineProperty({__proto__:null,load:Ze},Symbol.toStringTag,{value:"Module"})),et=async(w,y,a,q,x)=>{const l=Math.ceil(w.size/1e7),k=new Array(l).fill(0).map((t,i)=>i).reverse(),G=(t,i,p)=>x.mutation(He,{modId:y,versionId:p,part:i,file:t}).toPromise(),C=10;let h=0,b=0;const u=t=>{if(h>=C||!k.length)return;const i=k.pop(),p=i*1e7,$=w.slice(p,p+1e7);return h+=1,Promise.all([G($,i+1,t).then(()=>(h-=1,q.set({total:l,uploaded:l-k.length-h}),u(t))).catch(m=>{if(console.error("Upload failed:",m),h-=1,k.push(i),b+=1,b<5)return u(t);throw new Error("Failed uploading after 5 attempts")}),u(t)])};return x.mutation(De,{modId:y}).toPromise().then(async t=>(q.set({total:l,uploaded:0}),await u(t.data.createVersion),t.data.createVersion)).then(t=>(console.log("Finalizing",{versionID:t}),x.mutation(Ke,{modId:y,versionId:t,version:a}).toPromise().then(()=>new Promise((i,p)=>{let $=0,m=me({query:Re,client:x,variables:{modId:y,versionId:t},requestPolicy:"network-only"});const P=setInterval(()=>{if($==60)return clearInterval(P),p(new Error("Timed out waiting for mod processing"));m.pause(),m.resume(),$++},1e4),M=m.subscribe(v=>{if(!v.fetching){if(v.error){clearInterval(P),p(new Error(v.error.message)),setTimeout(M);return}v.data?.checkVersionUploadState?.version?.id&&(M(),clearInterval(P),i(v.data.checkVersionUploadState))}})})))).catch(t=>{throw console.error(t),t})};r[F]="src/routes/mod/[modId]/new-version/+page.svelte";var tt=B(I("<p>Loading...</p>"),r[F],[[126,6]]),at=B(I("<p> </p>"),r[F],[[128,6]]),ot=B(I('<div class="relative pt-4"><div class="mb-2 flex items-center justify-between"><div><span class="inline-block rounded-full bg-yellow-600 px-2 py-1 text-xs font-semibold text-white uppercase"> </span></div> <div class="text-right"><span class="inline-block text-xs font-semibold text-white"> </span></div></div> <div class="mb-4 flex h-2 overflow-hidden rounded bg-neutral-600 text-xs"><div class="flex flex-col justify-center bg-yellow-600 text-center whitespace-nowrap text-white shadow-none"></div></div></div>'),r[F],[[133,8,[[134,10,[[135,12,[[136,14]]],[141,12,[[142,14]]]]],[145,10,[[146,12]]]]]]),rt=B(I('<!> <!> <div class="p-4"><span>Edit Compatibility Info</span></div> <div class="card preset-filled-surface-100-900 p-4"><!></div>',1),r[F],[[154,6,[[155,8]]],[157,6]]),st=B(I('<div class="flex h-auto flex-wrap items-center justify-between"><h1 class="my-4 text-4xl font-bold">New Version for <!></h1> <div><!> <button class="btn border border-primary-500 preset-tonal-primary" title="View the description page for this mod"><span class="material-icons pr-2">arrow_back</span> </button></div></div> <div class="card preset-filled-surface-100-900 p-4"><section><!></section></div>',1),r[F],[[96,0,[[97,2],[105,2,[[113,4,[[117,6]]]]]]],[123,0,[[124,2]]]]);function r(w,y){Me(new.target),Ee(y,!0,r);const a=()=>(A(i,"mod"),j(i,"$mod",l)),q=()=>(A(G,"t"),j(G,"$t",l)),x=()=>(A(b,"uploadStatus"),j(b,"$uploadStatus",l)),L=()=>(A(u,"uploadPercent"),j(u,"$uploadPercent",l)),[l,k]=Ne(),{t:G}=ze(),{modId:C}=y.data,h=Te(),b=W(""),u=W(0),t=W();t.subscribe(e=>{e&&(Ue(e.uploaded,e.total)?(b.set("Processing..."),u.set(100)):(b.set(`Uploading: ${e.uploaded}/${e.total}`),u.set(e.uploaded/e.total*100)))});const i=me({query:Je,client:h,variables:{mod:C}}),p=async e=>et(e.file,a().data.mod.id,{changelog:e.changelog,stability:e.stability},t,h).then(o=>{pe.success({description:"Version created",duration:5e3}),de(le+"/mod/"+C+"/version/"+o.version.id)}).catch(o=>{console.error(...Ae("error",o)),pe.error({description:"Error creating version: "+o.message}),b.set("")}),$=()=>{de(le+"/mod/"+C)};let m=Be(Oe(!1),"backModalOpen");var P={...Ie()},M=st();qe(e=>{var o=X(),E=T(o);{var z=f=>{c(()=>We(f,{get description(){return`Creating a new version of mod ${a().data.mod.name??""}`},get title(){return`New version of mod ${a().data.mod.name??""}`}}),"component",r,90,4,{componentTag:"MetaDescriptors"})};c(()=>V(E,f=>{!a().fetching&&!a().error&&a().data.mod&&f(z)}),"if",r,89,2)}d(e,o)});var v=T(M),Q=s(v),ve=_(s(Q));{var fe=e=>{var o=ue("...");d(e,o)},ge=e=>{var o=X(),E=T(o);{var z=f=>{var g=ue();O(()=>U(g,a().data.mod.name)),d(f,g)};c(()=>V(E,f=>{a().error||f(z)},!0),"if",r,101,4)}d(e,o)};c(()=>V(ve,e=>{a().fetching?e(fe):e(ge,!1)}),"if",r,99,4)}n(Q);var Y=_(Q,2),Z=s(Y);c(()=>Ye(Z,{title:"Go Back?",body:"Going back will discard any unsaved changes. Are you sure you wish to continue?",buttonTextCancel:"Keep Editing",buttonTextConfirm:"Go Back",confirm:$,get open(){return je(m)},set open(e){ce(m,e,!0)}}),"component",r,106,4,{componentTag:"BasicModal"});var D=_(Z,2);D.__click=()=>ce(m,!0);var _e=_(s(D));n(D),n(Y),n(v);var ee=_(v,2),te=s(ee),he=s(te);{var be=e=>{var o=tt();d(e,o)},ye=e=>{var o=X(),E=T(o);{var z=g=>{var S=at(),N=s(S);n(S),O(()=>U(N,`Oh no... ${a().error.message??""}`)),d(g,S)},f=g=>{var S=rt(),N=T(S);c(()=>Qe(N,{onSubmit:p,get modReference(){return a().data.mod.mod_reference},submitIcon:"add_circle"}),"component",r,130,6,{componentTag:"VersionForm"});var ae=_(N,2);{var we=K=>{var R=ot(),H=s(R),J=s(H),re=s(J),$e=s(re,!0);n(re),n(J);var se=_(J,2),ne=s(se),Se=s(ne);n(ne),n(se),n(H);var ie=_(H,2),Ve=s(ie);n(ie),n(R),O((Fe,Ce)=>{U($e,x()),U(Se,`${Fe??""}%`),Le(Ve,`width: ${Ce??""}%`)},[()=>L().toFixed(0),()=>L().toFixed(0)]),d(K,R)};c(()=>V(ae,K=>{x()&&K(we)}),"if",r,132,6)}var oe=_(ae,4),ke=s(oe);c(()=>Xe(ke,{get mod(){return a().data.mod},get modId(){return a().data.mod.id},$$events:{fail:()=>{alert("Failed to update compatibility information, check browser console for more info.")},submit:()=>{alert("Mod compatibility data updated. Don't forget to upload the version too!")}}}),"component",r,158,8,{componentTag:"EditCompatibilityForm"}),n(oe),d(g,S)};c(()=>V(E,g=>{a().error?g(z):g(f,!1)},!0),"if",r,127,4)}d(e,o)};c(()=>V(he,e=>{a().fetching?e(be):e(ye,!1)}),"if",r,125,4)}n(te),n(ee),O(e=>U(_e,` ${e??""}`),[()=>q()("version.back")]),d(w,M);var xe=Ge(P);return k(),xe}Pe(["click"]);export{r as component,mt as universal};
//# sourceMappingURL=18.B25s5d6u.js.map
