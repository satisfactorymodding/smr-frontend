{"version":3,"file":"18.DwMW9bqs.js","sources":["../../../../../../src/routes/mod/[modId]/new-version/+page.ts","../../../../../../src/lib/utils/chunked-upload.ts","../../../../../../src/routes/mod/[modId]/new-version/+page.svelte"],"sourcesContent":["import type { PageLoad } from './$types';\n\nexport const load: PageLoad = async ({ params }) => ({\n  ...params\n});\n","/* eslint-disable */\n\nimport type { File } from '$lib/models/file';\nimport type { Client } from 'urql';\nimport {\n  CheckVersionUploadStateDocument,\n  FinalizeCreateVersionDocument,\n  type Exact,\n  type NewVersion,\n  CreateVersionDocument,\n  UploadVersionPartDocument,\n  type CheckVersionUploadStateQuery\n} from '$lib/generated';\nimport type { Writable } from 'svelte/store';\nimport { queryStore } from '@urql/svelte';\n\nexport type UploadState = {\n  total: number;\n  uploaded: number;\n};\n\nexport type ChunkedResponse = CheckVersionUploadStateQuery['checkVersionUploadState'];\n\nexport const chunkedUpload = async (\n  file: File,\n  modId: string,\n  version: NewVersion,\n  state: Writable<UploadState>,\n  client: Client\n): Promise<ChunkedResponse> => {\n  const chunkSize = 10000000; // ~ 10MB\n\n  const chunksQuantity = Math.ceil(file.size / chunkSize);\n  const chunksQueue = new Array(chunksQuantity)\n    .fill(0)\n    .map((_, index) => index)\n    .reverse();\n\n  const upload = (chunk: Blob, chunkId: number, versionID: string) => {\n    return client\n      .mutation(UploadVersionPartDocument, {\n        modId: modId,\n        versionId: versionID,\n        part: chunkId,\n        file: chunk\n      })\n      .toPromise();\n  };\n\n  const threadsQuantity = 10;\n  let activeConnections = 0;\n  let retries = 0;\n  const sendNext = (versionID: string) => {\n    if (activeConnections >= threadsQuantity) {\n      return;\n    }\n\n    if (!chunksQueue.length) {\n      return;\n    }\n\n    const chunkId = chunksQueue.pop();\n    const begin = chunkId * chunkSize;\n    const chunk = file.slice(begin, begin + chunkSize);\n\n    activeConnections += 1;\n\n    return Promise.all([\n      upload(chunk, chunkId + 1, versionID)\n        .then(() => {\n          activeConnections -= 1;\n\n          state.set({\n            total: chunksQuantity,\n            uploaded: chunksQuantity - chunksQueue.length - activeConnections\n          });\n\n          return sendNext(versionID);\n        })\n        .catch((err) => {\n          console.error('Upload failed:', err);\n          activeConnections -= 1;\n          chunksQueue.push(chunkId);\n          retries += 1;\n          if (retries < 5) {\n            return sendNext(versionID);\n          } else {\n            throw new Error('Failed uploading after 5 attempts');\n          }\n        }),\n      sendNext(versionID)\n    ]);\n  };\n\n  return client\n    .mutation(CreateVersionDocument, { modId })\n    .toPromise()\n    .then(async (data) => {\n      state.set({\n        total: chunksQuantity,\n        uploaded: 0\n      });\n\n      await sendNext(data.data.createVersion);\n\n      return data.data.createVersion;\n    })\n    .then((versionID) => {\n      console.log('Finalizing', { versionID });\n\n      return client\n        .mutation(FinalizeCreateVersionDocument, { modId, versionId: versionID, version })\n        .toPromise()\n        .then(() => {\n          return new Promise<ChunkedResponse>((resolve, reject) => {\n            let tries = 0;\n            let checkVersionUploadState = queryStore({\n              query: CheckVersionUploadStateDocument,\n              client,\n              variables: {\n                modId: modId,\n                versionId: versionID\n              },\n              requestPolicy: 'network-only'\n            });\n            const interval = setInterval(() => {\n              if (tries == 60) {\n                clearInterval(interval);\n                return reject(new Error('Timed out waiting for mod processing'));\n              }\n\n              checkVersionUploadState.pause();\n              checkVersionUploadState.resume();\n              tries++;\n            }, 10000);\n\n            const unsub = checkVersionUploadState.subscribe((data) => {\n              if (data.fetching) {\n                return;\n              }\n\n              if (data.error) {\n                clearInterval(interval);\n                reject(new Error(data.error.message));\n                setTimeout(unsub);\n                return;\n              }\n\n              if (!data.data?.checkVersionUploadState?.version?.id) {\n                return;\n              }\n\n              unsub();\n              clearInterval(interval);\n              resolve(data.data.checkVersionUploadState);\n            });\n          });\n        });\n    })\n    .catch((err) => {\n      console.error(err);\n      throw err;\n    });\n};\n","<script lang=\"ts\">\n  import { getContextClient, queryStore } from '@urql/svelte';\n  import { goto } from '$app/navigation';\n  import type { VersionData } from '$lib/models/versions';\n  import VersionForm from '$lib/components/versions/VersionForm.svelte';\n  import { GetModDocument } from '$lib/generated';\n  import { writable } from 'svelte/store';\n  import { chunkedUpload } from '$lib/utils/chunked-upload';\n  import type { UploadState } from '$lib/utils/chunked-upload';\n  import { base } from '$app/paths';\n  import MetaDescriptors from '$lib/components/utils/MetaDescriptors.svelte';\n  import type { PageData } from './$types';\n  import EditCompatibilityForm from '$lib/components/mods/compatibility/EditCompatibilityForm.svelte';\n  import { getTranslate } from '@tolgee/svelte';\n  import { toaster } from '$lib/utils/toaster-svelte';\n  import BasicModal from '$lib/components/general/BasicModal.svelte';\n\n  const { t } = getTranslate();\n\n  interface Props {\n    data: PageData;\n  }\n\n  let { data }: Props = $props();\n\n  const { modId } = data;\n\n  const client = getContextClient();\n\n  const uploadStatus = writable<undefined | string>('');\n  const uploadPercent = writable<number>(0);\n\n  const uploadState = writable<UploadState>();\n\n  uploadState.subscribe((up) => {\n    if (up) {\n      if (up.uploaded === up.total) {\n        uploadStatus.set(`Processing...`);\n        uploadPercent.set(100);\n      } else {\n        uploadStatus.set(`Uploading: ${up.uploaded}/${up.total}`);\n        uploadPercent.set((up.uploaded / up.total) * 100);\n      }\n    }\n  });\n\n  const mod = queryStore({\n    query: GetModDocument,\n    client,\n    variables: { mod: modId }\n  });\n\n  const onSubmit = async (versionData: VersionData) =>\n    chunkedUpload(\n      versionData.file,\n      $mod.data.mod.id,\n      {\n        changelog: versionData.changelog,\n        stability: versionData.stability\n      },\n      uploadState,\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      client\n    )\n      .then((success) => {\n        toaster.success({\n          description: `Version created`,\n          duration: 5000\n        });\n        goto(base + '/mod/' + modId + '/version/' + success.version.id);\n      })\n      .catch((err) => {\n        console.error(err);\n        toaster.error({\n          description: 'Error creating version: ' + err.message\n        });\n        uploadStatus.set('');\n      });\n\n  const goBackFn = () => {\n    goto(base + '/mod/' + modId);\n  };\n\n  let backModalOpen = $state(false);\n</script>\n\n<svelte:head>\n  {#if !$mod.fetching && !$mod.error && $mod.data.mod}\n    <MetaDescriptors\n      description=\"Creating a new version of mod {$mod.data.mod.name}\"\n      title=\"New version of mod {$mod.data.mod.name}\" />\n  {/if}\n</svelte:head>\n\n<div class=\"flex h-auto flex-wrap items-center justify-between\">\n  <h1 class=\"my-4 text-4xl font-bold\">\n    New Version for\n    {#if $mod.fetching}\n      ...\n    {:else if !$mod.error}\n      {$mod.data.mod.name}\n    {/if}\n  </h1>\n  <div>\n    <BasicModal\n      bind:open={backModalOpen}\n      title=\"Go Back?\"\n      body=\"Going back will discard any unsaved changes. Are you sure you wish to continue?\"\n      buttonTextCancel=\"Keep Editing\"\n      buttonTextConfirm=\"Go Back\"\n      confirm={goBackFn} />\n    <button\n      class=\"btn border border-primary-500 preset-tonal-primary\"\n      title=\"View the description page for this mod\"\n      onclick={() => (backModalOpen = true)}>\n      <span class=\"material-icons pr-2\">arrow_back</span>\n      {$t('version.back')}\n    </button>\n  </div>\n</div>\n\n<div class=\"card preset-filled-surface-100-900 p-4\">\n  <section>\n    {#if $mod.fetching}\n      <p>Loading...</p>\n    {:else if $mod.error}\n      <p>Oh no... {$mod.error.message}</p>\n    {:else}\n      <VersionForm {onSubmit} modReference={$mod.data.mod.mod_reference} submitIcon=\"add_circle\" />\n\n      {#if $uploadStatus}\n        <div class=\"relative pt-4\">\n          <div class=\"mb-2 flex items-center justify-between\">\n            <div>\n              <span\n                class=\"inline-block rounded-full bg-yellow-600 px-2 py-1 text-xs font-semibold text-white uppercase\">\n                {$uploadStatus}\n              </span>\n            </div>\n            <div class=\"text-right\">\n              <span class=\"inline-block text-xs font-semibold text-white\">{$uploadPercent.toFixed(0)}%</span>\n            </div>\n          </div>\n          <div class=\"mb-4 flex h-2 overflow-hidden rounded bg-neutral-600 text-xs\">\n            <div\n              style=\"width: {$uploadPercent.toFixed(0)}%\"\n              class=\"flex flex-col justify-center bg-yellow-600 text-center whitespace-nowrap text-white shadow-none\">\n            </div>\n          </div>\n        </div>\n      {/if}\n\n      <div class=\"p-4\">\n        <span>Edit Compatibility Info</span>\n      </div>\n      <div class=\"card preset-filled-surface-100-900 p-4\">\n        <EditCompatibilityForm\n          mod={$mod.data.mod}\n          modId={$mod.data.mod.id}\n          on:fail={() => {\n            alert('Failed to update compatibility information, check browser console for more info.');\n          }}\n          on:submit={() => {\n            alert(\"Mod compatibility data updated. Don't forget to upload the version too!\");\n          }} />\n      </div>\n    {/if}\n  </section>\n</div>\n"],"names":["load","params","chunkedUpload","file","modId","version","state","client","chunksQuantity","chunksQueue","_","index","upload","chunk","chunkId","versionID","UploadVersionPartDocument","threadsQuantity","activeConnections","retries","sendNext","begin","err","CreateVersionDocument","data","FinalizeCreateVersionDocument","resolve","reject","tries","checkVersionUploadState","queryStore","CheckVersionUploadStateDocument","interval","unsub","t","getTranslate","$$props","getContextClient","uploadStatus","writable","uploadPercent","uploadState","up","$.strict_equals","mod","GetModDocument","onSubmit","versionData","$mod","success","toaster","goto","base","$.log_if_contains_state","goBackFn","backModalOpen","$$render","consequent","$.template_effect","$.set_text","text_1","consequent_2","consequent_1","alternate","$$value","button","$.set","$uploadStatus","$uploadPercent","consequent_5","consequent_4","alternate_1","consequent_3","alternate_2","$0","text_2","$t"],"mappings":"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"}