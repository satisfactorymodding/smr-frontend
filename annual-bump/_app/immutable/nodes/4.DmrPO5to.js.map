{"version":3,"file":"4.DmrPO5to.js","sources":["../../../../../../src/routes/admin/announcements/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { run } from 'svelte/legacy';\n\n  import { getContextClient, queryStore } from '@urql/svelte';\n  import {\n    GetAnnouncementsDocument,\n    CreateAnnouncementDocument,\n    type Announcement,\n    AnnouncementImportance,\n    UpdateAnnouncementDocument,\n    DeleteAnnouncementDocument\n  } from '$lib/generated';\n  import { Accordion } from '@skeletonlabs/skeleton-svelte';\n  import { toaster } from '$lib/utils/toaster-svelte';\n  const client = getContextClient();\n\n  let announcements: Announcement[] = $state([]);\n  const nameFields = $state({});\n  let announcementNegativeID = -1;\n  const defaultNewAnnouncementMessage = 'New Announcement';\n\n  const annQuery = queryStore({\n    query: GetAnnouncementsDocument,\n    client\n  });\n\n  run(() => {\n    announcements = $annQuery.data?.getAnnouncements || [];\n  });\n\n  function newAnnouncement() {\n    if (!announcements.find((announcement) => announcement.message == defaultNewAnnouncementMessage)) {\n      const announcement = {\n        id: announcementNegativeID--,\n        message: defaultNewAnnouncementMessage,\n        importance: AnnouncementImportance.Info\n      } as Announcement;\n      announcements.push(announcement);\n      announcements = announcements;\n      setTimeout(() => {\n        const field = nameFields[announcement.id];\n        field.focus();\n        const input = field.getElement().querySelectorAll('input')[0] as HTMLInputElement;\n        input.select();\n      }, 0);\n    } else {\n      nameFields[announcements[announcements.length - 1].id].focus();\n    }\n  }\n\n  async function announcementChange(announcement: Announcement) {\n    if (announcement.message == defaultNewAnnouncementMessage) {\n      return;\n    }\n\n    let success = false;\n    if (announcement.id < 0) {\n      // Create new tag & update tag.id with new DB id or re-fetch all tags\n      try {\n        const result = await client\n          .mutation(CreateAnnouncementDocument, {\n            announcement: { importance: announcement.importance, message: announcement.message }\n          })\n          .toPromise();\n        if (result.data) {\n          announcement.id = result.data.createAnnouncement.id;\n          success = true;\n        }\n      } catch (err) {\n        console.log(err);\n      }\n      if (!success) {\n        toaster.error({\n          description: `Failed to create Announcement '${announcement.message}'!`,\n          duration: 2000\n        });\n        return;\n      }\n    } else {\n      // Update existing tag\n      try {\n        if (announcement.message.length > 0) {\n          success =\n            (\n              await client\n                .mutation(UpdateAnnouncementDocument, {\n                  id: announcement.id,\n                  announcement: { importance: announcement.importance, message: announcement.message }\n                })\n                .toPromise()\n            ).data.updateAnnouncement != null;\n        }\n      } catch {\n        // nothing\n      }\n      if (!success) {\n        toaster.error({\n          description: `Failed to update Announcement '${announcement.message}'!`,\n          duration: 2000\n        });\n        return;\n      }\n    }\n\n    toaster.success({\n      description: `Announcement '${announcement.message}' saved!`,\n      duration: 2000\n    });\n  }\n\n  async function deleteAnnouncement(announcement: Announcement) {\n    if (announcement.message != defaultNewAnnouncementMessage) {\n      let success = false;\n      try {\n        const result = await client.mutation(DeleteAnnouncementDocument, { id: announcement.id }).toPromise();\n        success = result.data.deleteAnnouncement;\n      } catch {\n        success = false;\n      }\n      if (!success) {\n        toaster.error({\n          description: `Failed to remove Announcement '${announcement.message}'!`,\n          duration: 2000\n        });\n        return;\n      }\n    } else {\n      announcements.splice(announcements.indexOf(announcement), 1);\n    }\n\n    toaster.success({\n      description: `Tag '${announcement.message}' removed!`,\n      duration: 2000\n    });\n  }\n\n  function onDeleteClick(e: Event, announcement: Announcement) {\n    e.stopPropagation();\n    deleteAnnouncement(announcement);\n  }\n</script>\n\n<h1>Announcements</h1>\n\n<div class=\"card preset-filled-surface-100-900\">\n  {#if $annQuery.fetching}\n    <h1>Loading announcements...</h1>\n  {:else if $annQuery.error}\n    <h1>Failed to load announcements: {$annQuery.error.message}</h1>\n  {:else}\n    <Accordion>\n      {#each announcements as announcement (announcement.id)}\n        <Accordion.Item value={announcement.id}>\n          <Accordion.ItemTrigger>\n            ({announcement.importance}) {(() => {\n              const trimTo = 144;\n              const trimmed = announcement.message.substring(0, trimTo);\n              return announcement.message.length > trimTo ? trimmed + '...' : trimmed;\n            })()}\n          </Accordion.ItemTrigger>\n          <Accordion.ItemContent>\n            <div>\n              <div>Message</div>\n              <input\n                type=\"text\"\n                class=\"input p-2\"\n                bind:value={announcement.message}\n                placeholder=\"This is the text of the announcement\"\n                bind:this={nameFields[announcement.id]}\n                onchange={() => announcementChange(announcement)} />\n              <div>Importance (Fix, Info, Warning, Alert)</div>\n              <input\n                type=\"text\"\n                class=\"input p-2\"\n                bind:value={announcement.importance}\n                placeholder=\"Importance level\"\n                onchange={() => announcementChange(announcement)} />\n            </div>\n\n            <button\n              class=\"btn border border-error-500 preset-tonal-error\"\n              onclick={(e) => onDeleteClick(e, announcement)}>\n              <span>Delete</span>\n            </button>\n          </Accordion.ItemContent>\n        </Accordion.Item>\n      {/each}\n    </Accordion>\n\n    <section class=\"p-4\">\n      <button class=\"btn border border-primary-500 preset-tonal-primary\" onclick={newAnnouncement}>\n        <span>Add new announcement</span>\n        <span class=\"material-icons\">add</span>\n      </button>\n    </section>\n  {/if}\n</div>\n\n<style lang=\"postcss\">\n  @reference \"../../../app.css\";\n\n  h1 {\n    @apply my-4 text-4xl font-bold;\n  }\n</style>\n"],"names":["client","getContextClient","announcements","$.tag","$.state","$.proxy","nameFields","$.tag_proxy","announcementNegativeID","defaultNewAnnouncementMessage","annQuery","queryStore","GetAnnouncementsDocument","run","$.set","$annQuery","newAnnouncement","announcement","$.equals","$.get","AnnouncementImportance","field","announcementChange","success","result","$.track_reactivity_loss","CreateAnnouncementDocument","err","$.log_if_contains_state","toaster","UpdateAnnouncementDocument","deleteAnnouncement","DeleteAnnouncementDocument","onDeleteClick","$.validate_each_keys","$.each","node_3","$$index","$.template_effect","$0","$.set_text","text_1","trimmed","input_1","$.bind_this","$$value","input_2","button","e","$.bind_value","$$render","consequent_1","alternate","consequent","alternate_1"],"mappings":"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"}