{"version":3,"file":"4.D3ZDbVgW.js","sources":["../../../../../../src/routes/admin/announcements/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { getContextClient, queryStore } from '@urql/svelte';\n  import {\n    GetAnnouncementsDocument,\n    CreateAnnouncementDocument,\n    type Announcement,\n    AnnouncementImportance,\n    UpdateAnnouncementDocument,\n    DeleteAnnouncementDocument\n  } from '$lib/generated';\n  import { Accordion, AccordionItem, getToastStore } from '@skeletonlabs/skeleton';\n  const client = getContextClient();\n\n  let announcements: Announcement[] = [];\n  const nameFields = {};\n  let announcementNegativeID = -1;\n  const defaultNewAnnouncementMessage = 'New Announcement';\n\n  const annQuery = queryStore({\n    query: GetAnnouncementsDocument,\n    client\n  });\n\n  $: announcements = $annQuery.data?.getAnnouncements || [];\n\n  const toastStore = getToastStore();\n\n  function newAnnouncement() {\n    if (!announcements.find((announcement) => announcement.message == defaultNewAnnouncementMessage)) {\n      const announcement = {\n        id: announcementNegativeID--,\n        message: defaultNewAnnouncementMessage,\n        importance: AnnouncementImportance.Info\n      } as Announcement;\n      announcements.push(announcement);\n      announcements = announcements;\n      setTimeout(() => {\n        const field = nameFields[announcement.id];\n        field.focus();\n        const input = field.getElement().querySelectorAll('input')[0] as HTMLInputElement;\n        input.select();\n      }, 0);\n    } else {\n      nameFields[announcements[announcements.length - 1].id].focus();\n    }\n  }\n\n  async function announcementChange(announcement: Announcement) {\n    if (announcement.message == defaultNewAnnouncementMessage) {\n      return;\n    }\n\n    let success = false;\n    if (announcement.id < 0) {\n      // Create new tag & update tag.id with new DB id or re-fetch all tags\n      try {\n        const result = await client\n          .mutation(CreateAnnouncementDocument, {\n            announcement: { importance: announcement.importance, message: announcement.message }\n          })\n          .toPromise();\n        if (result.data) {\n          announcement.id = result.data.createAnnouncement.id;\n          success = true;\n        }\n      } catch (err) {\n        console.log(err);\n      }\n      if (!success) {\n        toastStore.trigger({\n          message: `Failed to create Announcement '${announcement.message}'!`,\n          background: 'variant-filled-error',\n          timeout: 2000\n        });\n        return;\n      }\n    } else {\n      // Update existing tag\n      try {\n        if (announcement.message.length > 0) {\n          success =\n            (\n              await client\n                .mutation(UpdateAnnouncementDocument, {\n                  id: announcement.id,\n                  announcement: { importance: announcement.importance, message: announcement.message }\n                })\n                .toPromise()\n            ).data.updateAnnouncement != null;\n        }\n      } catch {\n        // nothing\n      }\n      if (!success) {\n        toastStore.trigger({\n          message: `Failed to update Announcement '${announcement.message}'!`,\n          background: 'variant-filled-error',\n          timeout: 2000\n        });\n        return;\n      }\n    }\n\n    toastStore.trigger({\n      message: `Announcement '${announcement.message}' saved!`,\n      background: 'variant-filled-success',\n      timeout: 2000\n    });\n  }\n\n  async function deleteAnnouncement(announcement: Announcement) {\n    if (announcement.message != defaultNewAnnouncementMessage) {\n      let success = false;\n      try {\n        const result = await client.mutation(DeleteAnnouncementDocument, { id: announcement.id }).toPromise();\n        success = result.data.deleteAnnouncement;\n      } catch {\n        success = false;\n      }\n      if (!success) {\n        toastStore.trigger({\n          message: `Failed to remove Announcement '${announcement.message}'!`,\n          background: 'variant-filled-error',\n          timeout: 2000\n        });\n        return;\n      }\n    } else {\n      announcements.splice(announcements.indexOf(announcement), 1);\n    }\n\n    toastStore.trigger({\n      message: `Tag '${announcement.message}' removed!`,\n      background: 'variant-filled-success',\n      timeout: 2000\n    });\n  }\n\n  function onDeleteClick(e: Event, announcement: Announcement) {\n    e.stopPropagation();\n    deleteAnnouncement(announcement);\n  }\n</script>\n\n<h1>Announcements</h1>\n\n<div class=\"card\">\n  {#if $annQuery.fetching}\n    <h1>Loading announcements...</h1>\n  {:else if $annQuery.error}\n    <h1>Failed to load announcements: {$annQuery.error.message}</h1>\n  {:else}\n    <Accordion>\n      {#each announcements as announcement}\n        <AccordionItem>\n          <svelte:fragment slot=\"summary\"\n            >({announcement.importance}) {(() => {\n              const trimTo = 144;\n              const trimmed = announcement.message.substring(0, trimTo);\n              return announcement.message.length > trimTo ? trimmed + '...' : trimmed;\n            })()}</svelte:fragment>\n          <svelte:fragment slot=\"content\">\n            <div>\n              <div>Message</div>\n              <input\n                type=\"text\"\n                class=\"input p-2\"\n                bind:value={announcement.message}\n                placeholder=\"This is the text of the announcement\"\n                bind:this={nameFields[announcement.id]}\n                on:change={() => announcementChange(announcement)} />\n              <div>Importance (Fix, Info, Warning, Alert)</div>\n              <input\n                type=\"text\"\n                class=\"input p-2\"\n                bind:value={announcement.importance}\n                placeholder=\"Importance level\"\n                on:change={() => announcementChange(announcement)} />\n            </div>\n\n            <button class=\"variant-ghost-error btn\" on:click={(e) => onDeleteClick(e, announcement)}>\n              <span>Delete</span>\n            </button>\n          </svelte:fragment>\n        </AccordionItem>\n      {/each}\n    </Accordion>\n\n    <section class=\"p-4\">\n      <button class=\"variant-ghost-primary btn\" on:click={newAnnouncement}>\n        <span>Add new announcement</span>\n        <span class=\"material-icons\">add</span>\n      </button>\n    </section>\n  {/if}\n</div>\n\n<style lang=\"postcss\">\n  h1 {\n    @apply my-4 text-4xl font-bold;\n  }\n</style>\n"],"names":["insert_hydration","target","section","anchor","append_hydration","button","ctx","error","message","h1","set_data","t1","t1_value","importance","dirty","div2","div0","input0","set_input_value","div1","input1","value","length","i","each_blocks","fetching","div","defaultNewAnnouncementMessage","client","getContextClient","announcements","nameFields","announcementNegativeID","annQuery","queryStore","query","GetAnnouncementsDocument","toastStore","getToastStore","newAnnouncement","find","announcement","id","focus","AnnouncementImportance","Info","push","setTimeout","field","getElement","querySelectorAll","select","async","announcementChange","success","result","mutation","CreateAnnouncementDocument","toPromise","data","createAnnouncement","err","console","log","trigger","background","timeout","UpdateAnnouncementDocument","updateAnnouncement","deleteAnnouncement","DeleteAnnouncementDocument","splice","indexOf","onDeleteClick","e","stopPropagation","this","$$value","change_handler","change_handler_1","click_handler","trimmed","substring","trimTo","$annQuery","getAnnouncements"],"mappings":"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"}