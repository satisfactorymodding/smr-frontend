import{af as rt,S as Rt,i as Tt,d as A,s as Ot,v as Mt,Y as vt,Z as X,_ as $t,a8 as ot,a4 as bt,aj as wt,a5 as nt,w as tt,a6 as at,a7 as qt,f as xt,b as M,e as k,a0 as z,H as zt,j as h,k as q,g as I,h as D,a1 as U,J as mt,K as j,m as S,M as x,n as N,O as Ut,r as K,t as J,q as yt,a3 as Y,u as Q,x as At,G as st,I as it,L as ct,Q as lt,p as kt,l as It}from"../chunks/vendor.DET3Hlwf.js";import{V as Vt}from"../chunks/VersionForm.83L8YHwY.js";import{y as Gt,F as Ht,z as Kt,B as Lt,t as St}from"../chunks/graphql.JkthYSgF.js";import{M as Ct}from"../chunks/MetaDescriptors.CUrdeFAp.js";import{E as Dt}from"../chunks/EditCompatibilityForm._nNI3lGF.js";const Jt=async({params:n})=>({...n}),ee=Object.freeze(Object.defineProperty({__proto__:null,load:Jt},Symbol.toStringTag,{value:"Module"})),Et=async(n,t,s,r,e)=>{const m=Math.ceil(n.size/1e7),d=new Array(m).fill(0).map((c,o)=>o).reverse(),i=(c,o,l)=>e.mutation(Lt,{modId:t,versionId:l,part:o,file:c}).toPromise(),b=10;let P=0,p=0;const y=c=>{if(P>=b||!d.length)return;const o=d.pop(),l=o*1e7,g=n.slice(l,l+1e7);return P+=1,Promise.all([i(g,o+1,c).then(()=>(P-=1,r.set({total:m,uploaded:m-d.length-P}),y(c))).catch(f=>{if(console.error("Upload failed:",f),P-=1,d.push(o),p+=1,p<5)return y(c);throw new Error("Failed uploading after 5 attempts")}),y(c)])};return e.mutation(Gt,{modId:t}).toPromise().then(async c=>(r.set({total:m,uploaded:0}),await y(c.data.createVersion),c.data.createVersion)).then(c=>(console.log("Finalizing",{versionID:c}),e.mutation(Ht,{modId:t,versionId:c,version:s}).toPromise().then(()=>new Promise((o,l)=>{let g=0,f=rt({query:Kt,client:e,variables:{modId:t,versionId:c},requestPolicy:"network-only"});const v=setInterval(()=>{if(g==60)return clearInterval(v),l(new Error("Timed out waiting for mod processing"));f.pause(),f.resume(),g++},1e4),V=f.subscribe(_=>{if(!_.fetching){if(_.error){clearInterval(v),l(new Error(_.error.message)),setTimeout(V);return}_.data?.checkVersionUploadState?.version?.id&&(V(),clearInterval(v),o(_.data.checkVersionUploadState))}})})))).catch(c=>{throw console.error(c),c})},{console:Pt}=qt,E="src/routes/mod/[modId]/new-version/+page.svelte";function dt(n){let t,s;t=new Ct({props:{description:"Creating a new version of mod "+n[1].data.mod.name,title:"New version of mod "+n[1].data.mod.name},$$inline:!0});const r={c:function(){st(t.$$.fragment)},l:function(a){it(t.$$.fragment,a)},m:function(a,m){ct(t,a,m),s=!0},p:function(a,m){const d={};m&2&&(d.description="Creating a new version of mod "+a[1].data.mod.name),m&2&&(d.title="New version of mod "+a[1].data.mod.name),t.$set(d)},i:function(a){s||(K(t.$$.fragment,a),s=!0)},o:function(a){J(t.$$.fragment,a),s=!1},d:function(a){lt(t,a)}};return A("SvelteRegisterBlock",{block:r,id:dt.name,type:"if",source:"(80:2) {#if !$mod.fetching && !$mod.error && $mod.data.mod}",ctx:n}),r}function _t(n){let t=n[1].data.mod.name+"",s;const r={c:function(){s=z(t)},l:function(a){s=U(a,t)},m:function(a,m){N(a,s,m)},p:function(a,m){m&2&&t!==(t=a[1].data.mod.name+"")&&Y(s,t)},d:function(a){a&&h(s)}};return A("SvelteRegisterBlock",{block:r,id:_t.name,type:"if",source:"(92:26) ",ctx:n}),r}function jt(n){let t;const s={c:function(){t=z("...")},l:function(e){t=U(e,"...")},m:function(e,a){N(e,t,a)},p:Q,d:function(e){e&&h(t)}};return A("SvelteRegisterBlock",{block:s,id:jt.name,type:"if",source:"(90:4) {#if $mod.fetching}",ctx:n}),s}function Bt(n){let t,s,r,e,a,m="Edit Compatibility Info",d,i,b,P;t=new Vt({props:{onSubmit:n[8],modReference:n[1].data.mod.mod_reference,submitIcon:"add_circle"},$$inline:!0});let p=n[3]&&ft(n);b=new Dt({props:{mod:n[1].data.mod,modId:n[1].data.mod.id},$$inline:!0}),b.$on("fail",n[13]),b.$on("submit",n[14]);const y={c:function(){st(t.$$.fragment),s=M(),p&&p.c(),r=M(),e=k("div"),a=k("span"),a.textContent=m,d=M(),i=k("div"),st(b.$$.fragment),this.h()},l:function(o){it(t.$$.fragment,o),s=q(o),p&&p.l(o),r=q(o),e=I(o,"DIV",{class:!0});var l=D(e);a=I(l,"SPAN",{"data-svelte-h":!0}),mt(a)!=="svelte-d0elmi"&&(a.textContent=m),l.forEach(h),d=q(o),i=I(o,"DIV",{class:!0});var g=D(i);it(b.$$.fragment,g),g.forEach(h),this.h()},h:function(){S(a,E,159,8,4440),j(e,"class","p-4"),S(e,E,158,6,4414),j(i,"class","card p-4"),S(i,E,161,6,4496)},m:function(o,l){ct(t,o,l),N(o,s,l),p&&p.m(o,l),N(o,r,l),N(o,e,l),x(e,a),N(o,d,l),N(o,i,l),ct(b,i,null),P=!0},p:function(o,l){const g={};l&2&&(g.modReference=o[1].data.mod.mod_reference),t.$set(g),o[3]?p?p.p(o,l):(p=ft(o),p.c(),p.m(r.parentNode,r)):p&&(p.d(1),p=null);const f={};l&2&&(f.mod=o[1].data.mod),l&2&&(f.modId=o[1].data.mod.id),b.$set(f)},i:function(o){P||(K(t.$$.fragment,o),K(b.$$.fragment,o),P=!0)},o:function(o){J(t.$$.fragment,o),J(b.$$.fragment,o),P=!1},d:function(o){o&&(h(s),h(r),h(e),h(d),h(i)),lt(t,o),p&&p.d(o),lt(b)}};return A("SvelteRegisterBlock",{block:y,id:Bt.name,type:"else",source:"(113:4) {:else}",ctx:n}),y}function Nt(n){let t,s,r=n[1].error.message+"",e;const a={c:function(){t=k("p"),s=z("Oh no... "),e=z(r),this.h()},l:function(d){t=I(d,"P",{});var i=D(t);s=U(i,"Oh no... "),e=U(i,r),i.forEach(h),this.h()},h:function(){S(t,E,133,6,3395)},m:function(d,i){N(d,t,i),x(t,s),x(t,e)},p:function(d,i){i&2&&r!==(r=d[1].error.message+"")&&Y(e,r)},i:Q,o:Q,d:function(d){d&&h(t)}};return A("SvelteRegisterBlock",{block:a,id:Nt.name,type:"if",source:"(111:25) ",ctx:n}),a}function Ft(n){let t,s="Loading...";const r={c:function(){t=k("p"),t.textContent=s,this.h()},l:function(a){t=I(a,"P",{"data-svelte-h":!0}),mt(t)!=="svelte-qdsr2u"&&(t.textContent=s),this.h()},h:function(){S(t,E,131,6,3345)},m:function(a,m){N(a,t,m)},p:Q,i:Q,o:Q,d:function(a){a&&h(t)}};return A("SvelteRegisterBlock",{block:r,id:Ft.name,type:"if",source:"(109:4) {#if $mod.fetching}",ctx:n}),r}function ft(n){let t,s,r,e,a,m,d,i,b=n[4].toFixed(0)+"",P,p,y,c,o;const l={c:function(){t=k("div"),s=k("div"),r=k("div"),e=k("span"),a=z(n[3]),m=M(),d=k("div"),i=k("span"),P=z(b),p=z("%"),y=M(),c=k("div"),o=k("div"),this.h()},l:function(f){t=I(f,"DIV",{class:!0});var v=D(t);s=I(v,"DIV",{class:!0});var V=D(s);r=I(V,"DIV",{});var _=D(r);e=I(_,"SPAN",{class:!0});var G=D(e);a=U(G,n[3]),G.forEach(h),_.forEach(h),m=q(V),d=I(V,"DIV",{class:!0});var w=D(d);i=I(w,"SPAN",{class:!0});var T=D(i);P=U(T,b),p=U(T,"%"),T.forEach(h),w.forEach(h),V.forEach(h),y=q(v),c=I(v,"DIV",{class:!0});var R=D(c);o=I(R,"DIV",{style:!0,class:!0}),D(o).forEach(h),R.forEach(h),v.forEach(h),this.h()},h:function(){j(e,"class","inline-block rounded-full bg-yellow-600 px-2 py-1 text-xs font-semibold uppercase text-white"),S(e,E,141,14,3702),S(r,E,140,12,3682),j(i,"class","inline-block text-xs font-semibold text-white"),S(i,E,147,14,3950),j(d,"class","text-right"),S(d,E,146,12,3911),j(s,"class","mb-2 flex items-center justify-between"),S(s,E,139,10,3617),It(o,"width",n[4].toFixed(0)+"%"),j(o,"class","flex flex-col justify-center whitespace-nowrap bg-yellow-600 text-center text-white shadow-none"),S(o,E,151,12,4179),j(c,"class","mb-4 flex h-2 overflow-hidden rounded bg-neutral-600 text-xs"),S(c,E,150,10,4092),j(t,"class","relative pt-4"),S(t,E,138,8,3579)},m:function(f,v){N(f,t,v),x(t,s),x(s,r),x(r,e),x(e,a),x(s,m),x(s,d),x(d,i),x(i,P),x(i,p),x(t,y),x(t,c),x(c,o)},p:function(f,v){v&8&&Y(a,f[3]),v&16&&b!==(b=f[4].toFixed(0)+"")&&Y(P,b),v&16&&It(o,"width",f[4].toFixed(0)+"%")},d:function(f){f&&h(t)}};return A("SvelteRegisterBlock",{block:l,id:ft.name,type:"if",source:"(116:6) {#if $uploadStatus}",ctx:n}),l}function ut(n){let t,s,r,e,a,m,d,i,b,P="arrow_back",p,y=n[2]("version.back")+"",c,o,l,g,f,v,V,_,G,w=!n[1].fetching&&!n[1].error&&n[1].data.mod&&dt(n);function T(F,$){if(F[1].fetching)return jt;if(!F[1].error)return _t}let R=T(n),C=R&&R(n);const W=[Ft,Nt,Bt],O=[];function u(F,$){return F[1].fetching?0:F[1].error?1:2}f=u(n),v=O[f]=W[f](n);const L={c:function(){w&&w.c(),t=xt(),s=M(),r=k("div"),e=k("h1"),a=z(`New Version for
    `),C&&C.c(),m=M(),d=k("div"),i=k("button"),b=k("span"),b.textContent=P,p=M(),c=z(y),o=M(),l=k("div"),g=k("section"),v.c(),this.h()},l:function($){const B=zt("svelte-nx2zao",document.head);w&&w.l(B),t=xt(),B.forEach(h),s=q($),r=I($,"DIV",{class:!0});var H=D(r);e=I(H,"H1",{class:!0});var et=D(e);a=U(et,`New Version for
    `),C&&C.l(et),et.forEach(h),m=q(H),d=I(H,"DIV",{});var pt=D(d);i=I(pt,"BUTTON",{class:!0,title:!0});var Z=D(i);b=I(Z,"SPAN",{class:!0,"data-svelte-h":!0}),mt(b)!=="svelte-qua3zr"&&(b.textContent=P),p=q(Z),c=U(Z,y),Z.forEach(h),pt.forEach(h),H.forEach(h),o=q($),l=I($,"DIV",{class:!0});var ht=D(l);g=I(ht,"SECTION",{});var gt=D(g);v.l(gt),gt.forEach(h),ht.forEach(h),this.h()},h:function(){j(e,"class","my-4 text-4xl font-bold"),S(e,E,109,2,2834),j(b,"class","material-icons pr-2"),S(b,E,122,6,3170),j(i,"class","variant-ghost-primary btn"),j(i,"title","View the description page for this mod"),S(i,E,118,4,3009),S(d,E,117,2,2999),j(r,"class","flex h-auto flex-wrap items-center justify-between"),S(r,E,108,0,2767),S(g,E,129,2,3305),j(l,"class","card p-4"),S(l,E,128,0,3280)},m:function($,B){w&&w.m(document.head,null),x(document.head,t),N($,s,B),N($,r,B),x(r,e),x(e,a),C&&C.m(e,null),x(r,m),x(r,d),x(d,i),x(i,b),x(i,p),x(i,c),N($,o,B),N($,l,B),x(l,g),O[f].m(g,null),V=!0,_||(G=Ut(i,"click",n[12],!1,!1,!1,!1),_=!0)},p:function($,[B]){!$[1].fetching&&!$[1].error&&$[1].data.mod?w?(w.p($,B),B&2&&K(w,1)):(w=dt($),w.c(),K(w,1),w.m(t.parentNode,t)):w&&(kt(),J(w,1,1,()=>{w=null}),yt()),R===(R=T($))&&C?C.p($,B):(C&&C.d(1),C=R&&R($),C&&(C.c(),C.m(e,null))),(!V||B&4)&&y!==(y=$[2]("version.back")+"")&&Y(c,y);let H=f;f=u($),f===H?O[f].p($,B):(kt(),J(O[H],1,1,()=>{O[H]=null}),yt(),v=O[f],v?v.p($,B):(v=O[f]=W[f]($),v.c()),K(v,1),v.m(g,null))},i:function($){V||(K(w),K(v),V=!0)},o:function($){J(w),J(v),V=!1},d:function($){$&&(h(s),h(r),h(o),h(l)),w&&w.d($),h(t),C&&C.d(),O[f].d(),_=!1,G()}};return A("SvelteRegisterBlock",{block:L,id:ut.name,type:"component",source:"",ctx:n}),L}function Qt(n,t,s){let r,e,a=Q,m=()=>(a(),a=At(p,u=>s(2,e=u)),p),d,i;n.$$.on_destroy.push(()=>a());let{$$slots:b={},$$scope:P}=t;Mt("Page",b,[]);const{t:p}=vt();X(p,"t"),m();let{data:y}=t;const{modId:c}=y,o=$t(),l=tt("");X(l,"uploadStatus"),ot(n,l,u=>s(3,d=u));const g=tt(0);X(g,"uploadPercent"),ot(n,g,u=>s(4,i=u));const f=tt();f.subscribe(u=>{u&&(u.uploaded===u.total?(l.set("Processing..."),g.set(100)):(l.set(`Uploading: ${u.uploaded}/${u.total}`),g.set(u.uploaded/u.total*100)))});const v=bt(),V=rt({query:St,client:o,variables:{mod:c}});X(V,"mod"),ot(n,V,u=>s(1,r=u));const _=async u=>Et(u.file,r.data.mod.id,{changelog:u.changelog,stability:u.stability},f,o).then(L=>{v.trigger({message:"Version created",background:"variant-filled-success",timeout:5e3}),nt(at+"/mod/"+c+"/version/"+L.version.id)}).catch(L=>{console.error(L),v.trigger({message:"Error creating version: "+L.message,background:"variant-filled-error",autohide:!1}),l.set("")}),G=()=>{nt(at+"/mod/"+c)},w={type:"confirm",title:"Go Back?",buttonTextCancel:"Keep Editing",buttonTextConfirm:"Go Back",body:"Going back will discard any unsaved changes. Are you sure you wish to continue?",response:u=>{u&&G()}},T=wt();n.$$.on_mount.push(function(){y===void 0&&!("data"in t||n.$$.bound[n.$$.props.data])&&Pt.warn("<Page> was created without expected prop 'data'")});const R=["data"];Object.keys(t).forEach(u=>{!~R.indexOf(u)&&u.slice(0,2)!=="$$"&&u!=="slot"&&Pt.warn(`<Page> was created with unknown prop '${u}'`)});const C=()=>T.trigger(w),W=()=>{alert("Failed to update compatibility information, check browser console for more info.")},O=()=>{alert("Mod compatibility data updated. Don't forget to upload the version too!")};return n.$$set=u=>{"data"in u&&s(11,y=u.data)},n.$capture_state=()=>({getContextClient:$t,queryStore:rt,goto:nt,VersionForm:Vt,GetModDocument:St,writable:tt,chunkedUpload:Et,base:at,MetaDescriptors:Ct,getModalStore:wt,getToastStore:bt,EditCompatibilityForm:Dt,getTranslate:vt,t:p,data:y,modId:c,client:o,uploadStatus:l,uploadPercent:g,uploadState:f,toastStore:v,mod:V,onSubmit:_,goBackFn:G,backModal:w,modalStore:T,$mod:r,$t:e,$uploadStatus:d,$uploadPercent:i}),n.$inject_state=u=>{"data"in u&&s(11,y=u.data)},t&&"$$inject"in t&&n.$inject_state(t.$$inject),[p,r,e,d,i,l,g,V,_,w,T,y,C,W,O]}class oe extends Rt{constructor(t){super(t),Tt(this,t,Qt,ut,Ot,{t:0,data:11}),A("SvelteRegisterComponent",{component:this,tagName:"Page",options:t,id:ut.name})}get t(){return this.$$.ctx[0]}set t(t){throw new Error("<Page>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get data(){throw new Error("<Page>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set data(t){throw new Error("<Page>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{oe as component,ee as universal};
//# sourceMappingURL=18.Bn8wkvFR.js.map
